name: Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Make
        run: sudo apt-get install make

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Tests
        run: |
          export SECRET_KEY="${{ secrets.SECRET_KEY }}"
          coverage run --source=. manage.py test

      - name: Extract coverage percentage
        run: |
          coverage_output=$(coverage report --skip-covered)
          coverage_percentage=$(echo "$coverage_output" | grep -oP '(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$' | grep -oP '\d+(?:\.\d+)?')
          echo "::set-env name=coverage_output::$coverage_output"
          echo "::set-env name=coverage_percentage::$coverage_percentage"

      # - name: Extract coverage percentage
      #   run: |
      #     {
      #       "coverage_output=$(coverage report --skip-covered)"
      #       "coverage_percentage=$(echo "$coverage_output" | grep -oP '(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$' | grep -oP '\d+(?:\.\d+)?')"
      #     } >> $GITHUB_OUTPUT

      #     {
      #       echo "### Workflow variables"
      #       echo "| Variable   | Value       |"
      #       echo "| ---------- | ----------- |"
      #       echo "| coverage_output  | $coverage_output  |"
      #       echo "| coverage_percentage | $coverage_percentage |"
      #     } >> $GITHUB_STEP_SUMMARY

      # - name: Display coverage info
      # - run: |
      #     echo "${{ steps.env-setup.outputs.coverage_output }}"
      #     echo "${{ steps.env-setup.outputs.coverage_percentage }}"

      # - name: Check coverage threshold
      #   if: ${{ env.coverage_percentage < '90' }}
      #   run: exit 1  # Fail the workflow if coverage is less than 90%
      #   else:
      #     run: echo "Coverage is m8!"
